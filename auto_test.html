<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—²ç‰©æ ¡å›­ - è‡ªåŠ¨åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        h3 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .summary { font-size: 18px; font-weight: bold; text-align: center; padding: 15px; margin: 20px 0; border-radius: 8px; }
        .pass { background-color: #28a745; color: white; }
        .fail { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ é—²ç‰©æ ¡å›­ - è‡ªåŠ¨åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š</h1>
        <div id="testResults"></div>
        <div id="testSummary"></div>
    </div>

    <script>
        class AutoTester {
            constructor() {
                this.results = [];
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
            }

            // è®°å½•æµ‹è¯•ç»“æœ
            log(testName, success, message = '') {
                this.totalTests++;
                const status = success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
                const className = success ? 'success' : 'error';
                
                if (success) {
                    this.passedTests++;
                } else {
                    this.failedTests++;
                }
                
                this.results.push({
                    testName,
                    success,
                    message,
                    status,
                    className
                });
            }

            // æµ‹è¯•æœ¬åœ°å­˜å‚¨
            testLocalStorage() {
                try {
                    // æµ‹è¯•å†™å…¥
                    localStorage.setItem('test_key', 'test_value');
                    
                    // æµ‹è¯•è¯»å–
                    const value = localStorage.getItem('test_key');
                    if (value !== 'test_value') {
                        throw new Error('è¯»å–çš„å€¼ä¸å†™å…¥çš„ä¸åŒ¹é…');
                    }
                    
                    // æµ‹è¯•åˆ é™¤
                    localStorage.removeItem('test_key');
                    const deletedValue = localStorage.getItem('test_key');
                    if (deletedValue !== null) {
                        throw new Error('åˆ é™¤åä»èƒ½è¯»å–åˆ°å€¼');
                    }
                    
                    this.log('æœ¬åœ°å­˜å‚¨åŸºç¡€åŠŸèƒ½', true, 'æœ¬åœ°å­˜å‚¨å¯ä»¥æ­£å¸¸è¯»å†™åˆ é™¤æ•°æ®');
                } catch (error) {
                    this.log('æœ¬åœ°å­˜å‚¨åŸºç¡€åŠŸèƒ½', false, error.message);
                }
            }

            // æµ‹è¯•JSONæ•°æ®æ“ä½œ
            testJSONOperations() {
                try {
                    const testData = {
                        users: [
                            { id: 1, name: 'å¼ ä¸‰', email: 'zhang@example.com' },
                            { id: 2, name: 'æå››', email: 'li@example.com' }
                        ],
                        items: [
                            { id: 1, title: 'æ•°å­¦ä¹¦', price: 35.00 }
                        ]
                    };
                    
                    // æµ‹è¯•JSONåºåˆ—åŒ–å’Œå­˜å‚¨
                    const jsonString = JSON.stringify(testData);
                    localStorage.setItem('test_json', jsonString);
                    
                    // æµ‹è¯•JSONååºåˆ—åŒ–
                    const retrievedString = localStorage.getItem('test_json');
                    const retrievedData = JSON.parse(retrievedString);
                    
                    if (retrievedData.users.length !== 2 || retrievedData.items.length !== 1) {
                        throw new Error('JSONæ•°æ®è§£æåç»“æ„ä¸æ­£ç¡®');
                    }
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    localStorage.removeItem('test_json');
                    
                    this.log('JSONæ•°æ®æ“ä½œ', true, 'JSONåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ­£å¸¸');
                } catch (error) {
                    this.log('JSONæ•°æ®æ“ä½œ', false, error.message);
                }
            }

            // æµ‹è¯•ç”¨æˆ·æ•°æ®ç®¡ç†
            testUserManagement() {
                try {
                    // æ¸…ç†ç°æœ‰ç”¨æˆ·æ•°æ®
                    localStorage.removeItem('xianwu_users');
                    
                    // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
                    const testUsers = [
                        {
                            user_id: 'test_user_001',
                            username: 'æµ‹è¯•ç”¨æˆ·1',
                            email: 'test1@example.com',
                            campus_id: '2021001001',
                            password: 'password123',
                            is_verified: true
                        },
                        {
                            user_id: 'test_user_002',
                            username: 'æµ‹è¯•ç”¨æˆ·2',
                            email: 'test2@example.com',
                            campus_id: '2021001002',
                            password: 'password456',
                            is_verified: false
                        }
                    ];
                    
                    // å­˜å‚¨ç”¨æˆ·æ•°æ®
                    localStorage.setItem('xianwu_users', JSON.stringify(testUsers));
                    
                    // è¯»å–ç”¨æˆ·æ•°æ®
                    const storedUsers = JSON.parse(localStorage.getItem('xianwu_users') || '[]');
                    
                    if (storedUsers.length !== 2) {
                        throw new Error('ç”¨æˆ·æ•°æ®å­˜å‚¨åæ•°é‡ä¸æ­£ç¡®');
                    }
                    
                    // æµ‹è¯•ç”¨æˆ·æŸ¥æ‰¾åŠŸèƒ½
                    const foundUser = storedUsers.find(u => u.email === 'test1@example.com' && u.password === 'password123');
                    if (!foundUser) {
                        throw new Error('æ— æ³•é€šè¿‡é‚®ç®±å’Œå¯†ç æ‰¾åˆ°ç”¨æˆ·');
                    }
                    
                    // æµ‹è¯•ç”¨æˆ·ç™»å½•çŠ¶æ€
                    localStorage.setItem('xianwu_current_user', JSON.stringify(foundUser));
                    const currentUser = JSON.parse(localStorage.getItem('xianwu_current_user'));
                    if (!currentUser || currentUser.user_id !== 'test_user_001') {
                        throw new Error('ç”¨æˆ·ç™»å½•çŠ¶æ€ä¿å­˜å¤±è´¥');
                    }
                    
                    this.log('ç”¨æˆ·æ•°æ®ç®¡ç†', true, 'ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æ•°æ®å­˜å‚¨åŠŸèƒ½æ­£å¸¸');
                } catch (error) {
                    this.log('ç”¨æˆ·æ•°æ®ç®¡ç†', false, error.message);
                }
            }

            // æµ‹è¯•ç‰©å“æ•°æ®ç®¡ç†
            testItemManagement() {
                try {
                    // æ¸…ç†ç°æœ‰ç‰©å“æ•°æ®
                    localStorage.removeItem('xianwu_items');
                    
                    // åˆ›å»ºæµ‹è¯•ç‰©å“
                    const testItems = [
                        {
                            item_id: 'test_item_001',
                            user_id: 'test_user_001',
                            title: 'é«˜ç­‰æ•°å­¦æ•™æ',
                            description: 'åŒæµå¤§å­¦ç¬¬ä¸ƒç‰ˆï¼Œä¹æˆæ–°',
                            price: 35.00,
                            category: 'ä¹¦ç±',
                            status: 'å¾…å”®'
                        },
                        {
                            item_id: 'test_item_002',
                            user_id: 'test_user_002',
                            title: 'å°ç±³è“ç‰™è€³æœº',
                            description: 'ä½¿ç”¨åŠå¹´ï¼ŒåŠŸèƒ½æ­£å¸¸',
                            price: 120.00,
                            category: 'ç”µå­äº§å“',
                            status: 'å¾…å”®'
                        }
                    ];
                    
                    // å­˜å‚¨ç‰©å“æ•°æ®
                    localStorage.setItem('xianwu_items', JSON.stringify(testItems));
                    
                    // è¯»å–ç‰©å“æ•°æ®
                    const storedItems = JSON.parse(localStorage.getItem('xianwu_items') || '[]');
                    
                    if (storedItems.length !== 2) {
                        throw new Error('ç‰©å“æ•°æ®å­˜å‚¨åæ•°é‡ä¸æ­£ç¡®');
                    }
                    
                    // æµ‹è¯•ç‰©å“æœç´¢åŠŸèƒ½
                    const keyword = 'æ•°å­¦';
                    const filteredItems = storedItems.filter(item => 
                        item.title.toLowerCase().includes(keyword.toLowerCase()) || 
                        item.description.toLowerCase().includes(keyword.toLowerCase())
                    );
                    
                    if (filteredItems.length !== 1) {
                        throw new Error('ç‰©å“æœç´¢åŠŸèƒ½ä¸æ­£å¸¸');
                    }
                    
                    this.log('ç‰©å“æ•°æ®ç®¡ç†', true, 'ç‰©å“å‘å¸ƒã€æœç´¢åŠŸèƒ½æ­£å¸¸');
                } catch (error) {
                    this.log('ç‰©å“æ•°æ®ç®¡ç†', false, error.message);
                }
            }

            // æµ‹è¯•äº¤æ˜“æ•°æ®ç®¡ç†
            testTransactionManagement() {
                try {
                    // æ¸…ç†ç°æœ‰äº¤æ˜“æ•°æ®
                    localStorage.removeItem('xianwu_transactions');
                    
                    // åˆ›å»ºæµ‹è¯•äº¤æ˜“
                    const testTransactions = [
                        {
                            transaction_id: 'test_trans_001',
                            item_id: 'test_item_001',
                            buyer_id: 'test_user_002',
                            seller_id: 'test_user_001',
                            status: 'äº¤æ˜“ä¸­',
                            create_time: new Date().toISOString()
                        }
                    ];
                    
                    // å­˜å‚¨äº¤æ˜“æ•°æ®
                    localStorage.setItem('xianwu_transactions', JSON.stringify(testTransactions));
                    
                    // è¯»å–äº¤æ˜“æ•°æ®
                    const storedTransactions = JSON.parse(localStorage.getItem('xianwu_transactions') || '[]');
                    
                    if (storedTransactions.length !== 1) {
                        throw new Error('äº¤æ˜“æ•°æ®å­˜å‚¨åæ•°é‡ä¸æ­£ç¡®');
                    }
                    
                    // æµ‹è¯•äº¤æ˜“çŠ¶æ€æ›´æ–°
                    storedTransactions[0].status = 'å·²å®Œæˆ';
                    localStorage.setItem('xianwu_transactions', JSON.stringify(storedTransactions));
                    
                    const updatedTransactions = JSON.parse(localStorage.getItem('xianwu_transactions'));
                    if (updatedTransactions[0].status !== 'å·²å®Œæˆ') {
                        throw new Error('äº¤æ˜“çŠ¶æ€æ›´æ–°å¤±è´¥');
                    }
                    
                    this.log('äº¤æ˜“æ•°æ®ç®¡ç†', true, 'äº¤æ˜“åˆ›å»ºã€çŠ¶æ€æ›´æ–°åŠŸèƒ½æ­£å¸¸');
                } catch (error) {
                    this.log('äº¤æ˜“æ•°æ®ç®¡ç†', false, error.message);
                }
            }

            // æµ‹è¯•ç™»å½•åŠŸèƒ½
            testLoginFunction() {
                try {
                    // ç¡®ä¿æµ‹è¯•ç”¨æˆ·å­˜åœ¨
                    const testUsers = [
                        {
                            user_id: 'login_test_user',
                            username: 'ç™»å½•æµ‹è¯•ç”¨æˆ·',
                            email: 'logintest@example.com',
                            password: 'test123456',
                            is_verified: true
                        }
                    ];
                    localStorage.setItem('xianwu_users', JSON.stringify(testUsers));
                    
                    // æ¨¡æ‹Ÿç™»å½•è¿‡ç¨‹
                    const email = 'logintest@example.com';
                    const password = 'test123456';
                    
                    const users = JSON.parse(localStorage.getItem('xianwu_users') || '[]');
                    const user = users.find(u => u.email === email && u.password === password);
                    
                    if (!user) {
                        throw new Error('ç™»å½•éªŒè¯å¤±è´¥');
                    }
                    
                    // æ¨¡æ‹Ÿä¿å­˜ç™»å½•çŠ¶æ€
                    localStorage.setItem('xianwu_current_user', JSON.stringify(user));
                    const currentUser = JSON.parse(localStorage.getItem('xianwu_current_user'));
                    
                    if (!currentUser || currentUser.user_id !== 'login_test_user') {
                        throw new Error('ç™»å½•çŠ¶æ€ä¿å­˜å¤±è´¥');
                    }
                    
                    // æµ‹è¯•ç™»å‡º
                    localStorage.removeItem('xianwu_current_user');
                    const afterLogout = localStorage.getItem('xianwu_current_user');
                    
                    if (afterLogout !== null) {
                        throw new Error('ç™»å‡ºåŠŸèƒ½ä¸æ­£å¸¸');
                    }
                    
                    this.log('ç™»å½•ç™»å‡ºåŠŸèƒ½', true, 'ç”¨æˆ·ç™»å½•ã€ç™»å‡ºåŠŸèƒ½æ­£å¸¸');
                } catch (error) {
                    this.log('ç™»å½•ç™»å‡ºåŠŸèƒ½', false, error.message);
                }
            }

            // æµ‹è¯•æ•°æ®å®Œæ•´æ€§
            testDataIntegrity() {
                try {
                    // åˆ›å»ºå®Œæ•´çš„æ•°æ®é›†
                    const completeData = {
                        users: [
                            {
                                user_id: 'complete_user_001',
                                username: 'å®Œæ•´æµ‹è¯•ç”¨æˆ·',
                                email: 'complete@example.com',
                                campus_id: '2021001001',
                                avatar: 'https://via.placeholder.com/150',
                                register_time: new Date().toISOString(),
                                is_verified: true,
                                password: 'complete123'
                            }
                        ],
                        items: [
                            {
                                item_id: 'complete_item_001',
                                user_id: 'complete_user_001',
                                title: 'å®Œæ•´æµ‹è¯•ç‰©å“',
                                description: 'è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æµ‹è¯•ç‰©å“',
                                price: 99.99,
                                category: 'æµ‹è¯•åˆ†ç±»',
                                status: 'å¾…å”®',
                                image_url: 'https://via.placeholder.com/300x200',
                                create_time: new Date().toISOString()
                            }
                        ],
                        transactions: [
                            {
                                transaction_id: 'complete_trans_001',
                                item_id: 'complete_item_001',
                                buyer_id: 'complete_user_001',
                                seller_id: 'complete_user_001',
                                status: 'å¾…å”®',
                                create_time: new Date().toISOString()
                            }
                        ]
                    };
                    
                    // å­˜å‚¨æ‰€æœ‰æ•°æ®
                    Object.keys(completeData).forEach(key => {
                        localStorage.setItem(`xianwu_${key}`, JSON.stringify(completeData[key]));
                    });
                    
                    // éªŒè¯æ•°æ®å®Œæ•´æ€§
                    let allDataValid = true;
                    let errorMessages = [];
                    
                    // æ£€æŸ¥ç”¨æˆ·æ•°æ®
                    const storedUsers = JSON.parse(localStorage.getItem('xianwu_users') || '[]');
                    if (storedUsers.length === 0) {
                        allDataValid = false;
                        errorMessages.push('ç”¨æˆ·æ•°æ®ä¸¢å¤±');
                    }
                    
                    // æ£€æŸ¥ç‰©å“æ•°æ®
                    const storedItems = JSON.parse(localStorage.getItem('xianwu_items') || '[]');
                    if (storedItems.length === 0) {
                        allDataValid = false;
                        errorMessages.push('ç‰©å“æ•°æ®ä¸¢å¤±');
                    }
                    
                    // æ£€æŸ¥äº¤æ˜“æ•°æ®
                    const storedTransactions = JSON.parse(localStorage.getItem('xianwu_transactions') || '[]');
                    if (storedTransactions.length === 0) {
                        allDataValid = false;
                        errorMessages.push('äº¤æ˜“æ•°æ®ä¸¢å¤±');
                    }
                    
                    // éªŒè¯æ•°æ®å…³è”æ€§
                    const user = storedUsers[0];
                    const item = storedItems.find(i => i.user_id === user.user_id);
                    if (!item) {
                        allDataValid = false;
                        errorMessages.push('ç”¨æˆ·ä¸ç‰©å“å…³è”æ€§é”™è¯¯');
                    }
                    
                    if (allDataValid) {
                        this.log('æ•°æ®å®Œæ•´æ€§', true, 'æ‰€æœ‰æ•°æ®ç±»å‹å®Œæ•´ï¼Œå…³è”æ€§æ­£ç¡®');
                    } else {
                        this.log('æ•°æ®å®Œæ•´æ€§', false, errorMessages.join(', '));
                    }
                    
                } catch (error) {
                    this.log('æ•°æ®å®Œæ•´æ€§', false, error.message);
                }
            }

            // æ¸…ç†æµ‹è¯•æ•°æ®
            cleanupTestData() {
                try {
                    const keysToRemove = [
                        'xianwu_users', 'xianwu_items', 'xianwu_transactions', 
                        'xianwu_current_user', 'xianwu_chats', 'xianwu_reviews'
                    ];
                    
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    this.log('æµ‹è¯•æ•°æ®æ¸…ç†', true, 'æ‰€æœ‰æµ‹è¯•æ•°æ®å·²æ¸…ç†');
                } catch (error) {
                    this.log('æµ‹è¯•æ•°æ®æ¸…ç†', false, error.message);
                }
            }

            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            runAllTests() {
                this.testLocalStorage();
                this.testJSONOperations();
                this.testUserManagement();
                this.testItemManagement();
                this.testTransactionManagement();
                this.testLoginFunction();
                this.testDataIntegrity();
                
                // å»¶è¿Ÿæ˜¾ç¤ºç»“æœï¼Œç¡®ä¿æ‰€æœ‰æµ‹è¯•å®Œæˆ
                setTimeout(() => {
                    this.displayResults();
                    this.cleanupTestData();
                }, 100);
            }

            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            displayResults() {
                let html = '<div class="test-section">';
                html += '<h2>ğŸ“Š è¯¦ç»†æµ‹è¯•ç»“æœ</h2>';
                
                this.results.forEach(result => {
                    html += `<div class="test-result ${result.className}">`;
                    html += `<strong>${result.testName}</strong>: ${result.status}`;
                    if (result.message) {
                        html += `<br><small>${result.message}</small>`;
                    }
                    html += '</div>';
                });
                
                html += '</div>';
                
                // æ˜¾ç¤ºæ‘˜è¦
                const passRate = ((this.passedTests / this.totalTests) * 100).toFixed(1);
                const summaryClass = this.failedTests === 0 ? 'pass' : 'fail';
                
                let summaryHtml = `<div class="summary ${summaryClass}">`;
                summaryHtml += `<h3>æµ‹è¯•æ‘˜è¦</h3>`;
                summaryHtml += `<p>æ€»æµ‹è¯•æ•°: ${this.totalTests}</p>`;
                summaryHtml += `<p>é€šè¿‡: ${this.passedTests} | å¤±è´¥: ${this.failedTests}</p>`;
                summaryHtml += `<p>é€šè¿‡ç‡: ${passRate}%</p>`;
                summaryHtml += '</div>';
                
                document.getElementById('testResults').innerHTML = html;
                document.getElementById('testSummary').innerHTML = summaryHtml;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            const tester = new AutoTester();
            tester.runAllTests();
        };
    </script>
</body>
</html>